/*
 * Wallaby.js - v1.0.1328
 * https://wallabyjs.com
 * Copyright (c) 2014-2022 Wallaby.js - All Rights Reserved.
 *
 * This source code file is a part of Wallaby.js and is a proprietary (closed source) software.

 * IMPORTANT:
 * Wallaby.js is a tool made by software developers for software developers with passion and love for what we do.
 * Pirating the tool is not only illegal and just morally wrong,
 * it is also unfair to other fellow programmers who are using it legally,
 * and very harmful for the tool and its future.
 */
function Runner(e){var t=this;this._globals=[],this._abort=!1,this.suite=e,this.total=e.total(),this.failures=0,this.on("test end",function(e){t.checkGlobals(e)}),this.on("hook end",function(e){t.checkGlobals(e)}),this.grep(/.*/),this.globals(this.globalProps().concat(extraGlobals()))}function filterLeaks(e,t){return filter(t,function(t){if(/^d+/.test(t))return!1;if(global.navigator&&/^getInterface/.test(t))return!1;if(global.navigator&&/^\d+/.test(t))return!1;if(/^mocha-/.test(t))return!1;var i=filter(e,function(e){return~e.indexOf("*")?0==t.indexOf(e.split("*")[0]):t==e});return 0==i.length&&(!global.navigator||"onerror"!==t)})}function extraGlobals(){if("object"==typeof process&&"string"==typeof process.version){var e=process.version.split(".").reduce(function(e,t){return e<<8|t});if(e<2315)return["errno"]}return[]}var EventEmitter=require("events").EventEmitter,debug=require("debug")("mocha:runner"),Test=require("./test"),utils=require("./utils"),filter=utils.filter,keys=utils.keys,globals=["setTimeout","clearTimeout","setInterval","clearInterval","XMLHttpRequest","Date","setImmediate","clearImmediate"];module.exports=Runner,Runner.immediately=global.setImmediate||process.nextTick,Runner.prototype.__proto__=EventEmitter.prototype,Runner.prototype.grep=function(e,t){return debug("grep %s",e),this._grep=e,this._invert=t,this.total=this.grepTotal(this.suite),this},Runner.prototype.grepTotal=function(e){var t=this,i=0;return e.eachTest(function(e){var r=t._grep.test(e.fullTitle());t._invert&&(r=!r),r&&i++}),i},Runner.prototype.globalProps=function(){for(var e=utils.keys(global),t=0;t<globals.length;++t)~utils.indexOf(e,globals[t])||e.push(globals[t]);return e},Runner.prototype.globals=function(e){return 0==arguments.length?this._globals:(debug("globals %j",e),this._globals=this._globals.concat(e),this)},Runner.prototype.checkGlobals=function(e){if(!this.ignoreLeaks){var t,i=this._globals,r=this.globalProps();e&&(i=i.concat(e._allowedGlobals||[])),this.prevGlobalsLength!=r.length&&(this.prevGlobalsLength=r.length,t=filterLeaks(i,r),this._globals=this._globals.concat(t),t.length>1?this.fail(e,new Error("global leaks detected: "+t.join(", "))):t.length&&this.fail(e,new Error("global leak detected: "+t[0])))}},Runner.prototype.fail=function(e,t){++this.failures,e.state="failed","string"==typeof t&&(t=new Error('the string "'+t+'" was thrown, throw an Error :)')),this.emit("fail",e,t)},Runner.prototype.failHook=function(e,t){this.fail(e,t),this.suite.bail()&&this.emit("end")},Runner.prototype.hook=function(e,t){function i(e){var r=n[e];return r?(s.currentRunnable=r,r.ctx.currentTest=s.test,s.emit("hook",r),r.on("error",function(e){s.failHook(r,e)}),void r.run(function(n){r.removeAllListeners("error");var o=r.error();return o&&s.fail(s.test,o),n?(s.failHook(r,n),t(n)):(s.emit("hook end",r),delete r.ctx.currentTest,void i(++e))})):t()}var r=this.suite,n=r["_"+e],s=this;Runner.immediately(function(){i(0)})},Runner.prototype.hooks=function(e,t,i){function r(o){return n.suite=o,o?void n.hook(e,function(e){if(e){var o=n.suite;return n.suite=s,i(e,o)}r(t.pop())}):(n.suite=s,i())}var n=this,s=this.suite;r(t.pop())},Runner.prototype.hookUp=function(e,t){var i=[this.suite].concat(this.parents()).reverse();this.hooks(e,i,t)},Runner.prototype.hookDown=function(e,t){var i=[this.suite].concat(this.parents());this.hooks(e,i,t)},Runner.prototype.parents=function(){for(var e=this.suite,t=[];e=e.parent;)t.push(e);return t},Runner.prototype.runTest=function(e){var t=this.test,i=this;this.asyncOnly&&(t.asyncOnly=!0);try{t.on("error",function(e){i.fail(t,e)}),t.run(e)}catch(r){e(r)}},Runner.prototype.runTests=function(e,t){function i(e,r,n){var o=s.suite;s.suite=n?r.parent:r,s.suite?s.hookUp("afterEach",function(e,n){return s.suite=o,e?i(e,n,!0):void t(r)}):(s.suite=o,t(r))}function r(a,l){if(s.failures&&e._bail)return t();if(s._abort)return t();if(a)return i(a,l,!0);if(n=o.shift(),!n)return t();var c=s._grep.test(n.fullTitle());return s._invert&&(c=!c),c?n.pending?(s.emit("pending",n),s.emit("test end",n),r()):(s.emit("test",s.test=n),void s.hookDown("beforeEach",function(e,t){return e?i(e,t,!1):(s.currentRunnable=s.test,void s.runTest(function(e){return n=s.test,e?(s.fail(n,e),s.emit("test end",n),s.hookUp("afterEach",r)):(n.state="passed",s.emit("pass",n),s.emit("test end",n),void s.hookUp("afterEach",r))}))})):r()}var n,s=this,o=e.tests.slice();this.next=r,r()},Runner.prototype.runSuite=function(e,t){function i(t){if(t)return t==e?r():r(t);if(s._abort)return r();var n=e.suites[o++];return n?void s.runSuite(n,i):r()}function r(i){s.suite=e,s.hook("afterAll",function(){s.emit("suite end",e),t(i)})}var n=this.grepTotal(e),s=this,o=0;return debug("run suite %s",e.fullTitle()),n?(this.emit("suite",this.suite=e),void this.hook("beforeAll",function(t){return t?r():void s.runTests(e,i)})):t()},Runner.prototype.uncaught=function(e){e?debug("uncaught exception %s",e!==function(){return this}.call(e)?e:e.message||e):(debug("uncaught undefined exception"),e=utils.undefinedError()),e.uncaught=!0;var t=this.currentRunnable;if(t){var i=t.state;if(this.fail(t,e),t.clearTimeout(),!i)return"test"==t.type?(this.emit("test end",t),void this.hookUp("afterEach",this.next)):void this.emit("end")}},Runner.prototype.run=function(e){function t(e){i.uncaught(e)}var i=this,e=e||function(){};return debug("start"),this.on("end",function(){debug("end"),process.removeListener("uncaughtException",t),e(i.failures)}),this.emit("start"),this.runSuite(this.suite,function(){debug("finished running"),i.emit("end")}),process.on("uncaughtException",t),this},Runner.prototype.abort=function(){debug("aborting"),this._abort=!0};